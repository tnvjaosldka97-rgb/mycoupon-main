import { useAuth } from '@/hooks/useAuth';
import { useState, useEffect, useCallback, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Gift, MapPin, Sparkles, TrendingUp, Users, Zap, Heart, Store, Ticket, Percent, Bell, Download, X, LogOut, User } from "lucide-react";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from "@/components/ui/dropdown-menu";
import { useLocation } from "wouter";
import { Link } from "wouter";
import { getLoginUrl } from "@/lib/const";
import { toast } from "sonner";
import { trpc } from "@/lib/trpc";
import { FloatingPromoWidget } from "@/components/FloatingPromoWidget";
import { InstallModal } from "@/components/InstallModal";
import { NotificationBadge } from "@/components/NotificationBadge";
import { InstallModeRestartModal } from "@/components/InstallModeRestartModal";
import { isInAppBrowser, redirectToChrome, getInAppBrowserName } from "@/lib/browserDetect";
import { Spinner } from "@/components/ui/spinner";

export default function Home() {
  const { user, loading } = useAuth();
  const [location, setLocation] = useLocation();
  const loginClickRef = useRef(false);
  const searchClickRef = useRef(false);
  const [isReady, setIsReady] = useState(false);
  const [isLoginLoading, setIsLoginLoading] = useState(false);
  const [isSearchLoading, setIsSearchLoading] = useState(false);
  
  // PWA standalone ëª¨ë“œ ê°ì§€ ë° ì´ˆê¸°í™” - ë²„íŠ¼ì´ ì¦‰ì‹œ ì‘ë™í•˜ë„ë¡ ë³´ì¥ (ê°•í™”ëœ ì•ˆì •í™” ì²´í¬)
  useEffect(() => {
    // install ëª¨ë“œì¼ ë•ŒëŠ” ì¦‰ì‹œ ready ì„¤ì • (ë²„íŠ¼ì´ ë°”ë¡œ ì‘ë™í•˜ë„ë¡)
    const installMode = sessionStorage.getItem('install-mode');
    if (installMode) {
      console.log('[Home] install ëª¨ë“œ ê°ì§€, ì¦‰ì‹œ ready ì„¤ì •');
      setIsReady(true);
      return;
    }
    
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                        (window.navigator as any).standalone || 
                        document.referrer.includes('android-app://');
    
    // ì•ˆì •í™” ìƒíƒœ ì²´í¬ í•¨ìˆ˜
    const checkStability = () => {
      // 1. DOMì´ ì™„ì „íˆ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
      const domReady = document.readyState === 'complete' || document.readyState === 'interactive';
      
      // 2. Reactê°€ ë§ˆìš´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
      const reactMounted = document.getElementById('root')?.hasChildNodes() || false;
      
      // 3. Service Worker ìƒíƒœ í™•ì¸
      const swReady = !('serviceWorker' in navigator) || 
                     navigator.serviceWorker.controller !== null ||
                     navigator.serviceWorker.ready !== undefined;
      
      // 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ë“±ë¡ë  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
      const canAttachEvents = typeof window.addEventListener === 'function';
      
      return domReady && reactMounted && swReady && canAttachEvents;
    };
    
    if (isStandalone) {
      console.log('[Home] PWA standalone ëª¨ë“œ ê°ì§€, ì´ˆê¸°í™” ì‹œì‘ (ê°•í™”ëœ ì•ˆì •í™” ì²´í¬)');
      
      // ì¦‰ì‹œ ì•ˆì •í™” ìƒíƒœ ì²´í¬
      if (checkStability()) {
        console.log('[Home] ì¦‰ì‹œ ì•ˆì •í™” ìƒíƒœ í™•ì¸, ready ì„¤ì •');
        setIsReady(true);
        return;
      }
      
      // Service Workerê°€ ready ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      if ('serviceWorker' in navigator) {
        const swReadyPromise = navigator.serviceWorker.ready.then(() => {
          console.log('[Home] Service Worker ready');
          return true;
        }).catch(() => {
          console.log('[Home] Service Worker ready ì‹¤íŒ¨, ê·¸ë˜ë„ ì§„í–‰');
          return true;
        });
        
        // DOMContentLoaded ì´ë²¤íŠ¸ ëŒ€ê¸°
        const domReadyPromise = new Promise<boolean>((resolve) => {
          if (document.readyState === 'complete' || document.readyState === 'interactive') {
            resolve(true);
          } else {
            document.addEventListener('DOMContentLoaded', () => resolve(true), { once: true });
          }
        });
        
        // ëª¨ë“  ì¡°ê±´ì´ ë§Œì¡±ë˜ë©´ ready ì„¤ì •
        Promise.all([swReadyPromise, domReadyPromise]).then(() => {
          if (checkStability()) {
            console.log('[Home] ëª¨ë“  ì•ˆì •í™” ì¡°ê±´ ë§Œì¡±, ready ì„¤ì •');
            setIsReady(true);
          }
        });
      } else {
        // Service Workerê°€ ì—†ì–´ë„ DOMë§Œ ì¤€ë¹„ë˜ë©´ ì§„í–‰
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setIsReady(true);
        } else {
          document.addEventListener('DOMContentLoaded', () => setIsReady(true), { once: true });
        }
      }
      
      // ìµœëŒ€ 500ms í›„ì—ëŠ” ë¬´ì¡°ê±´ readyë¡œ ì„¤ì • (íƒ€ì„ì•„ì›ƒ ì•ˆì „ì¥ì¹˜ - ë” ë¹ ë¥´ê²Œ)
      setTimeout(() => {
        setIsReady(true);
      }, 500);
    } else {
      // ì¼ë°˜ ë¸Œë¼ìš°ì € ëª¨ë“œì—ì„œëŠ” ì¦‰ì‹œ ready (ì„±ëŠ¥ ìµœì í™”)
      setIsReady(true);
    }
  }, []);
  
  // ë²„íŠ¼ ì¦‰ì‹œ í™œì„±í™” ë³´ì¥ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
  useEffect(() => {
    // DOMì´ ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ ready
    if (document.readyState !== 'loading') {
      setIsReady(true);
    }
  }, []);
  
  // ì „ì—­ ìƒíƒœ ë° ê²½ë¡œ ë™ê¸°í™”: í˜ì´ì§€ ë¡œë“œ ì§í›„ ì¸ì¦ ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜
  useEffect(() => {
    // ì„œë¹„ìŠ¤ ì›Œì»¤ë‚˜ ì´ì „ ìºì‹œ ë•Œë¬¸ì— ì”¹íˆì§€ ì•Šë„ë¡ ê°•ì œë¡œ ì¸ì¦ ìƒíƒœ í™•ì¸
    if (!loading) {
      console.log('[Home] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì¸ì¦ ìƒíƒœ:', user ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆ ë¨');
    }
  }, [user, loading]);
  
  // ë©ˆì¶¤ ìƒíƒœ ì´ˆê¸°í™”: í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ìƒíƒœ ì •ë¦¬
  useEffect(() => {
    // ì´ì „ ì„¸ì…˜ì˜ ë©ˆì¶¤ ìƒíƒœ ì œê±°
    const wasStuck = sessionStorage.getItem('pwa-was-stuck');
    if (wasStuck) {
      console.log('[Home] ì´ì „ ë©ˆì¶¤ ìƒíƒœ ê°ì§€, ìƒíƒœ ì´ˆê¸°í™”');
      sessionStorage.removeItem('pwa-was-stuck');
      // ì¸ì¦ ìƒíƒœë„ ê°•ì œë¡œ ë‹¤ì‹œ í™•ì¸
      if (!loading && !user) {
        // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ refetch
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }
    }
  }, [user, loading]);
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);
  const [showInstallBanner, setShowInstallBanner] = useState(false);
  const [showInstallModal, setShowInstallModal] = useState(false);
  const [showInstallModeRestartModal, setShowInstallModeRestartModal] = useState(false);
  const [isStandalone, setIsStandalone] = useState(false);
  const [isPWAInstalled, setIsPWAInstalled] = useState(false);
  const [isInstalling, setIsInstalling] = useState(false);
  const logoutMutation = trpc.auth.logout.useMutation({
    onSuccess: () => {
      // ë¡œê·¸ì•„ì›ƒ í›„ PWA ì„¤ì¹˜ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
      const standaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                            (window.navigator as any).standalone === true ||
                            document.referrer.includes('android-app://');
      
      // standalone ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼
      setIsPWAInstalled(standaloneMode);
      if (standaloneMode) {
        localStorage.setItem('pwa-installed', 'true');
      } else {
        localStorage.removeItem('pwa-installed');
      }
      
      // install ëª¨ë“œ í•´ì œ
      sessionStorage.removeItem('install-mode');
      
      // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
      // Reactê°€ ìë™ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ìƒˆë¡œê³ ì¹¨ ë¶ˆí•„ìš”
      console.log('[Home] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ, ìƒíƒœ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)');
    },
  });

  useEffect(() => {
    // install íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ (Chromeìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²½ìš°) ì„¤ì¹˜ ëª¨ë“œ í™œì„±í™”
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('install') === 'true') {
      console.log('[Home] install íŒŒë¼ë¯¸í„° ê°ì§€, ì„¤ì¹˜ ëª¨ë“œ í™œì„±í™”');
      const fromKakao = urlParams.get('from') === 'kakao';
      
      // ì¹´í†¡ì—ì„œ ì˜¨ ê²½ìš° ì„¤ì¹˜ ëª¨ë“œë§Œ í™œì„±í™” (ë¡œê·¸ì•„ì›ƒì€ í•˜ì§€ ì•ŠìŒ - í™”ë©´ ë©ˆì¶¤ ë°©ì§€)
      if (fromKakao) {
        console.log('[Home] ì¹´í†¡ì—ì„œ Chromeìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨, ì„¤ì¹˜ ëª¨ë“œ í™œì„±í™”');
        sessionStorage.setItem('install-mode', 'true');
        // ì¸ì¦ ê´€ë ¨ ì„¸ì…˜ë§Œ ì •ë¦¬ (ë¡œê·¸ì•„ì›ƒì€ í•˜ì§€ ì•ŠìŒ - í™”ë©´ ë©ˆì¶¤ ë°©ì§€)
        sessionStorage.removeItem('auth-refetched');
        // ë¡œë”© í™”ë©´ ê°•ì œ í•´ì œ (ë²„íŠ¼ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡)
        localStorage.setItem('pwa-loading-shown', 'true');
        
        // install ëª¨ë“œì¼ ë•ŒëŠ” ì¦‰ì‹œ ready ì„¤ì • (ë²„íŠ¼ì´ ë°”ë¡œ ì‘ë™í•˜ë„ë¡)
        setIsReady(true);
        console.log('[Home] install ëª¨ë“œ: ì¦‰ì‹œ ready ì„¤ì • ì™„ë£Œ');
        
        // install ëª¨ë“œì—ì„œ ì¼ì • ì‹œê°„ í›„ ë²„íŠ¼ì´ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
        const installModeCheckTimer = setTimeout(() => {
          // 10ì´ˆ í›„ì—ë„ install ëª¨ë“œì´ê³  PWAê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
          const stillInInstallMode = sessionStorage.getItem('install-mode');
          const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches;
          
          if (stillInInstallMode && !isStandaloneMode) {
            console.log('[Home] install ëª¨ë“œ íƒ€ì„ì•„ì›ƒ, ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ');
            setShowInstallModeRestartModal(true);
          }
        }, 10000); // 10ì´ˆ í›„ ì²´í¬
        
        // deferredPromptë¥¼ ë” ì ê·¹ì ìœ¼ë¡œ í™•ì¸ (ì¦‰ì‹œ ì²´í¬ + ì£¼ê¸°ì  ì²´í¬)
        const checkDeferredPrompt = () => {
          // ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
          if (deferredPrompt) {
            console.log('[Home] deferredPrompt ì´ë¯¸ ì„¤ì •ë¨');
            clearTimeout(installModeCheckTimer);
            return;
          }
          
          // beforeinstallprompt ì´ë²¤íŠ¸ê°€ ì•„ì§ ë°œìƒí•˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
          // ìµœëŒ€ 3ì´ˆê°„ ê¸°ë‹¤ë¦¬ë©´ì„œ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸
          let checkCount = 0;
          const maxChecks = 30; // 3ì´ˆê°„ 100msë§ˆë‹¤ ì²´í¬
          
          const interval = setInterval(() => {
            checkCount++;
            // deferredPromptëŠ” useEffectì—ì„œ ì„¤ì •ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ
            console.log(`[Home] deferredPrompt í™•ì¸ ì¤‘... (${checkCount}/${maxChecks})`);
            
            if (checkCount >= maxChecks) {
              clearInterval(interval);
              console.log('[Home] deferredPrompt í™•ì¸ ì™„ë£Œ (íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ì„¤ì •ë¨)');
            }
          }, 100);
          
          // cleanup í•¨ìˆ˜ì—ì„œ íƒ€ì´ë¨¸ ì •ë¦¬
          return () => {
            clearTimeout(installModeCheckTimer);
          };
        };
        
        // ì¦‰ì‹œ ì²´í¬ ì‹œì‘
        setTimeout(checkDeferredPrompt, 100);
        
        console.log('[Home] ì„¤ì¹˜ ëª¨ë“œ í™œì„±í™” ì™„ë£Œ, ë²„íŠ¼ í´ë¦­ ê°€ëŠ¥');
      }
      
      // install íŒŒë¼ë¯¸í„°ëŠ” ìœ ì§€ (deferredPrompt ëŒ€ê¸°ìš©)
      // ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ (Chromeì—ì„œ ë°”ë¡œ ì„¤ì¹˜ íŒì—…ì´ ëœ¨ë„ë¡)
    }
    
    // ì¹´í†¡ ì¸ì•± ë¸Œë¼ìš°ì €ëŠ” App.tsxì—ì„œ ëª¨ë‹¬ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•ŠìŒ
    
    // PWA ì„¤ì¹˜ ìƒíƒœ ì •í™•í•œ í™•ì¸
    const checkPWAInstallStatus = () => {
      // 1. standalone ëª¨ë“œ í™•ì¸ (ê°€ì¥ ì •í™•í•œ ë°©ë²• - ì´ê²ƒë§Œì´ ì§„ì§œ ì„¤ì¹˜ëœ ìƒíƒœ)
      const standaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                            (window.navigator as any).standalone === true ||
                            document.referrer.includes('android-app://');
      
      setIsStandalone(standaloneMode);
      
      // CRITICAL: ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†(!isStandalone)í–ˆë‹¤ë©´ localStorage ê°•ì œ ì´ˆê¸°í™”
      // ì•± ì‚­ì œ í›„ ì¬ì„¤ì¹˜ë¥¼ ìœ„í•´ ì´ì „ ê¸°ë¡ì„ ë¬´ì¡°ê±´ ì‚­ì œ
      if (!standaloneMode) {
        localStorage.removeItem('pwa-installed');
        // standalone ëª¨ë“œê°€ ì•„ë‹ˆë©´ í•­ìƒ ì„¤ì¹˜ ê°€ëŠ¥ ìƒíƒœ
        setIsPWAInstalled(false);
        console.log('[PWA ì„¤ì¹˜ ìƒíƒœ í™•ì¸] ë¸Œë¼ìš°ì € ëª¨ë“œ ê°ì§€ - localStorage ê°•ì œ ì´ˆê¸°í™”, ì„¤ì¹˜ ê°€ëŠ¥ ìƒíƒœë¡œ ì„¤ì •');
      } else {
        // standalone ëª¨ë“œë©´ ì„¤ì¹˜ëœ ìƒíƒœ
        localStorage.setItem('pwa-installed', 'true');
        setIsPWAInstalled(true);
      }
      
      console.log('[PWA ì„¤ì¹˜ ìƒíƒœ í™•ì¸]', {
        standaloneMode,
        isInstalled: standaloneMode,
        referrer: document.referrer,
        note: 'ë¸Œë¼ìš°ì € ëª¨ë“œ(!standalone)ì¼ ë•Œ localStorage ê°•ì œ ì‚­ì œí•˜ì—¬ ì¬ì„¤ì¹˜ ê°€ëŠ¥'
      });
    };
    
    // ì´ˆê¸° í™•ì¸
    checkPWAInstallStatus();
    
    // ì£¼ê¸°ì ìœ¼ë¡œ ì¬í™•ì¸ (5ì´ˆë§ˆë‹¤)
    const checkInterval = setInterval(checkPWAInstallStatus, 5000);
    
    // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê°ì§€ (CRITICAL: beforeinstallprompt ì´ë²¤íŠ¸ë¡œ ì¬ì„¤ì¹˜ í™œì„±í™”)
    const handleBeforeInstallPrompt = (e: Event) => {
      e.preventDefault();
      const promptEvent = e as any;
      setDeferredPrompt(promptEvent);
      console.log('[PWA] âœ… beforeinstallprompt ì´ë²¤íŠ¸ ë°œìƒ - ë¸Œë¼ìš°ì €ê°€ ì„¤ì¹˜ ê°€ëŠ¥ ì‹ í˜¸ ì œê³µ!');
      
      // CRITICAL: beforeinstallpromptê°€ ë°œìƒí•˜ë©´ ë¬´ì¡°ê±´ ì„¤ì¹˜ ê°€ëŠ¥ ìƒíƒœë¡œ ì„¤ì •
      // ì•± ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ê³¼ ë°°ë„ˆë¥¼ ì¦‰ì‹œ ë…¸ì¶œí•˜ê¸° ìœ„í•´
      setIsPWAInstalled(false);
      setIsStandalone(false); // ë¸Œë¼ìš°ì € ëª¨ë“œë¡œ ê°•ì œ ì„¤ì •
      localStorage.removeItem('pwa-installed'); // localStorage ê°•ì œ ì‚­ì œ
      
      // install ëª¨ë“œì´ê³  ì¹´í†¡ì—ì„œ ì˜¨ ê²½ìš° ì¦‰ì‹œ ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      const urlParams = new URLSearchParams(window.location.search);
      const fromKakao = urlParams.get('from') === 'kakao';
      const isInstallMode = sessionStorage.getItem('install-mode') || urlParams.get('install') === 'true';
      
      if (isInstallMode && fromKakao) {
        console.log('[PWA] ğŸš€ ì¹´í†¡â†’í¬ë¡¬ ë¦¬ë‹¤ì´ë ‰íŠ¸: deferredPrompt ì„¤ì • ì™„ë£Œ, ì¦‰ì‹œ ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ');
        
        // ì¦‰ì‹œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ (requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ, ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ê³¼ ë™ê¸°í™”)
        requestAnimationFrame(async () => {
          try {
            console.log('[PWA] ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì‹œì‘');
            setIsInstalling(true);
            
            await promptEvent.prompt();
            const { outcome } = await promptEvent.userChoice;
            
            console.log('[PWA] ì‚¬ìš©ì ì„ íƒ:', outcome);
            
            if (outcome === 'accepted') {
              toast.success('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! í™ˆ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
              setShowInstallBanner(false);
              localStorage.setItem('pwa-installed', 'true');
              setIsPWAInstalled(true);
              sessionStorage.removeItem('install-mode');
              
              setTimeout(() => {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark');
                document.body.style.backgroundColor = '#FFF5F0';
                document.body.style.color = '#000000';
              }, 100);
            } else {
              console.log('[PWA] ì‚¬ìš©ìê°€ ì„¤ì¹˜ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
              toast.info('ì•± ì„¤ì¹˜ë¥¼ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
            
            setDeferredPrompt(null);
            setIsInstalling(false);
          } catch (error) {
            console.error('[PWA] ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì˜¤ë¥˜:', error);
            toast.error('ì•± ì„¤ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            setIsInstalling(false);
          }
        }); // requestAnimationFrame ì‚¬ìš© - ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ê³¼ ë™ê¸°í™”í•˜ì—¬ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ
      } else if (isInstallMode) {
        console.log('[PWA] âœ… install ëª¨ë“œì—ì„œ deferredPrompt ì„¤ì • ì™„ë£Œ! ì•± ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”');
        toast.success('ì•±ì„ ì„¤ì¹˜í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        // CRITICAL: ì¼ë°˜ ë¸Œë¼ìš°ì € ì ‘ì† ì‹œì—ë„ beforeinstallpromptê°€ ë°œìƒí•˜ë©´ ë²„íŠ¼ ì¦‰ì‹œ í‘œì‹œ
        console.log('[PWA] âœ… beforeinstallprompt ì´ë²¤íŠ¸ë¡œ ì„¤ì¹˜ ë²„íŠ¼ í™œì„±í™” - ì¬ì„¤ì¹˜ ê°€ëŠ¥ ìƒíƒœ');
        // ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ê³  í† ìŠ¤íŠ¸ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ì ë°©í•´ ìµœì†Œí™”)
      }
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¦‰ì‹œ ë“±ë¡ (í˜ì´ì§€ ë¡œë“œ ì „ì—ë„ ê°ì§€ ê°€ëŠ¥í•˜ë„ë¡)
    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    
    // install ëª¨ë“œì¼ ë•ŒëŠ” deferredPromptë¥¼ ë” ì ê·¹ì ìœ¼ë¡œ í™•ì¸
    if (sessionStorage.getItem('install-mode')) {
      console.log('[PWA] install ëª¨ë“œ ê°ì§€, deferredPrompt í™•ì¸ ì‹œì‘');
      // ì´ë¯¸ ë°œìƒí•œ ì´ë²¤íŠ¸ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¦‰ì‹œ í™•ì¸
      setTimeout(() => {
        // deferredPromptëŠ” ë¹„ë™ê¸°ë¡œ ì„¤ì •ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ
        console.log('[PWA] install ëª¨ë“œ: deferredPrompt í™•ì¸ ì¤‘...');
      }, 500);
    }

    return () => {
      clearInterval(checkInterval);
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, [user, logoutMutation]);

  // handleInstallClick í•¨ìˆ˜ë¥¼ ë¨¼ì € ì •ì˜ (useEffectë³´ë‹¤ ì•ì—)
  const handleInstallClick = useCallback(async () => {
    console.log('[ì•± ë‹¤ìš´ë¡œë“œ] ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ë¨', { hasDeferredPrompt: !!deferredPrompt, isInApp: isInAppBrowser() });

    // Android ê¸°ê¸°ì¸ ê²½ìš°
    const isAndroidDevice = /Android/.test(navigator.userAgent);
    if (isAndroidDevice) {
      // ì¸ì•± ë¸Œë¼ìš°ì €ì¸ ê²½ìš° Chromeìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (isInAppBrowser()) {
        const browserName = getInAppBrowserName() || 'ì¸ì•± ë¸Œë¼ìš°ì €';
        toast.info(`${browserName}ì—ì„œëŠ” ì•±ì„ ì„¤ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Chromeìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...`, {
          duration: 3000,
        });
        
        // Chromeìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì„¤ì¹˜ ëª¨ë“œ íŒŒë¼ë¯¸í„° ì¶”ê°€)
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('install', 'true');
        currentUrl.searchParams.set('from', 'kakao');
        redirectToChrome(currentUrl.toString());
        return;
      }
      
      // Chrome ë¸Œë¼ìš°ì €ì¸ ê²½ìš°
      const isChromeBrowser = /Chrome/.test(navigator.userAgent) && !isInAppBrowser();
      if (isChromeBrowser) {
        // deferredPromptê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        if (deferredPrompt) {
          console.log('[ì•± ë‹¤ìš´ë¡œë“œ] deferredPrompt ë°œê²¬, ì¦‰ì‹œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ');
          setIsInstalling(true);
          
          try {
            // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            await deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            console.log('[ì•± ë‹¤ìš´ë¡œë“œ] ì‚¬ìš©ì ì„ íƒ:', outcome);
            
            if (outcome === 'accepted') {
              toast.success('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! í™ˆ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
              setShowInstallBanner(false);
              localStorage.setItem('pwa-installed', 'true');
              setIsPWAInstalled(true);
              sessionStorage.removeItem('install-mode');
              
              // ì„¤ì¹˜ ì™„ë£Œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
              setTimeout(() => {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark');
                document.body.style.backgroundColor = '#FFF5F0';
                document.body.style.color = '#000000';
              }, 100);
            } else {
              console.log('[ì•± ë‹¤ìš´ë¡œë“œ] ì‚¬ìš©ìê°€ ì„¤ì¹˜ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
              toast.info('ì•± ì„¤ì¹˜ë¥¼ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
            
            // deferredPromptëŠ” í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ nullë¡œ ì„¤ì •
            setDeferredPrompt(null);
            setIsInstalling(false);
          } catch (error) {
            console.error('[ì•± ë‹¤ìš´ë¡œë“œ] ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì˜¤ë¥˜:', error);
            toast.error('ì•± ì„¤ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            setIsInstalling(false);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë‹¬ í‘œì‹œ (ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ)
            setTimeout(() => {
              setShowInstallModal(true);
            }, 1000);
          }
          return;
        } else {
          // deferredPromptê°€ ì—†ìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ (ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ)
          console.log('[ì•± ë‹¤ìš´ë¡œë“œ] deferredPrompt ì—†ìŒ, ì„¤ì¹˜ ëª¨ë‹¬ í‘œì‹œ');
          setShowInstallModal(true);
          return;
        }
      }
      
      // Chromeì´ ì•„ë‹Œ ê²½ìš° Chromeìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      toast.info('Chrome ë¸Œë¼ìš°ì €ê°€ í•„ìš”í•©ë‹ˆë‹¤. Chromeìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...', {
        duration: 3000,
        });
        
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('install', 'true');
        redirectToChrome(currentUrl.toString());
        return;
      }

    // iOS ê¸°ê¸°ì¸ ê²½ìš°
    const isIOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOSDevice) {
      // ì¸ì•± ë¸Œë¼ìš°ì €ì¸ ê²½ìš° Safarië¡œ ì•ˆë‚´
      if (isInAppBrowser()) {
        const browserName = getInAppBrowserName() || 'ì¸ì•± ë¸Œë¼ìš°ì €';
        toast.warning(`${browserName}ì—ì„œëŠ” ì•±ì„ ì„¤ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Safari ë¸Œë¼ìš°ì €ë¡œ ì—´ì–´ì£¼ì„¸ìš”.`, {
          duration: 5000,
        });
        return;
      }
      
      // Safariê°€ ì•„ë‹Œ ê²½ìš° Safarië¡œ ì—´ê¸° ì•ˆë‚´
      const isSafariBrowser = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (!isSafariBrowser) {
        toast.warning("Safari ë¸Œë¼ìš°ì €ë¡œ ì—´ì–´ì£¼ì„¸ìš”. Safariì—ì„œë§Œ ì•±ì„ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", {
          duration: 5000,
        });
        return;
      }
      
      // Safariì¸ ê²½ìš° ì„¤ì¹˜ ê°€ì´ë“œ ëª¨ë‹¬ í‘œì‹œ (iOSëŠ” í•­ìƒ ìˆ˜ë™ ì„¤ì¹˜)
      setShowInstallModal(true);
      return;
    }

    // ê¸°íƒ€ ê¸°ê¸° (ë°ìŠ¤í¬í†± ë“±)
    toast.info('ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.');
  }, [deferredPrompt, setIsInstalling, setShowInstallBanner, setIsPWAInstalled]);

  // install íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œ ìë™ ì„¤ì¹˜ ì‹œë„ (ë³„ë„ í•¨ìˆ˜)
  const handleAutoInstall = useCallback(async () => {
    if (!deferredPrompt) {
      console.log('[PWA] handleAutoInstall: deferredPrompt ì—†ìŒ');
      return;
    }
    
    console.log('[PWA] ğŸš€ handleAutoInstall: ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì‹œì‘');
    setIsInstalling(true);
    
    try {
      // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      await deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      console.log('[PWA] handleAutoInstall: ì‚¬ìš©ì ì„ íƒ:', outcome);
      
      if (outcome === 'accepted') {
        toast.success('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! í™ˆ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
        setShowInstallBanner(false);
        localStorage.setItem('pwa-installed', 'true');
        setIsPWAInstalled(true);
        sessionStorage.removeItem('install-mode');
        
        setTimeout(() => {
          document.documentElement.classList.remove('dark');
          document.body.classList.remove('dark');
          document.body.style.backgroundColor = '#FFF5F0';
          document.body.style.color = '#000000';
        }, 100);
      } else {
        console.log('[PWA] handleAutoInstall: ì‚¬ìš©ìê°€ ì„¤ì¹˜ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
        toast.info('ì•± ì„¤ì¹˜ë¥¼ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      
      // deferredPromptëŠ” í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ nullë¡œ ì„¤ì •
      setDeferredPrompt(null);
      setIsInstalling(false);
    } catch (error) {
      console.error('[PWA] handleAutoInstall: ìë™ ì„¤ì¹˜ ì˜¤ë¥˜:', error);
      toast.error('ì•± ì„¤ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      setIsInstalling(false);
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë‹¬ í‘œì‹œ (ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ)
      setTimeout(() => {
        setShowInstallModal(true);
      }, 1000);
    }
  }, [deferredPrompt, setIsInstalling, setShowInstallBanner, setIsPWAInstalled]);

  // deferredPromptê°€ ì„¤ì •ë˜ë©´ install íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œ ìë™ ì„¤ì¹˜ ì‹œë„ (ì¹´í†¡â†’í¬ë¡¬ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œ)
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const fromKakao = urlParams.get('from') === 'kakao';
    const isInstallMode = urlParams.get('install') === 'true';
    
    if (isInstallMode && fromKakao) {
      // ì¹´í†¡ì—ì„œ ì˜¨ ê²½ìš° install-mode í”Œë˜ê·¸ ì„¤ì •
      sessionStorage.setItem('install-mode', 'true');
      
      // deferredPromptê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì¦‰ì‹œ ìë™ ì„¤ì¹˜ ì‹œë„
      if (deferredPrompt) {
        console.log('[PWA] ğŸš€ ì¹´í†¡â†’í¬ë¡¬: deferredPrompt ì´ë¯¸ ì„¤ì •ë¨, ì¦‰ì‹œ ìë™ ì„¤ì¹˜ ì‹œë„');
        // requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‹¤í–‰ (ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ê³¼ ë™ê¸°í™”)
        requestAnimationFrame(() => {
          handleAutoInstall();
        });
      } else {
        // deferredPromptê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬ (ë§¤ìš° ë¹ ë¥´ê²Œ)
        console.log('[PWA] ì¹´í†¡â†’í¬ë¡¬: deferredPrompt ëŒ€ê¸° ì¤‘...');
        
        let checkCount = 0;
        const maxChecks = 100; // ìµœëŒ€ 5ì´ˆê°„ ì²´í¬ (50ms * 100)
        
        const checkInterval = setInterval(() => {
          checkCount++;
          
          if (deferredPrompt) {
            console.log('[PWA] ğŸš€ ì¹´í†¡â†’í¬ë¡¬: deferredPrompt ê°ì§€ ì™„ë£Œ! ì¦‰ì‹œ ìë™ ì„¤ì¹˜ ì‹œë„');
            clearInterval(checkInterval);
            // requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‹¤í–‰ (ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ê³¼ ë™ê¸°í™”)
            requestAnimationFrame(() => {
              handleAutoInstall();
            });
          } else if (checkCount >= maxChecks) {
            // 2ì´ˆ í›„ì—ë„ deferredPromptê°€ ì—†ìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ
            console.log('[PWA] deferredPrompt íƒ€ì„ì•„ì›ƒ (2ì´ˆ), ì„¤ì¹˜ ëª¨ë‹¬ í‘œì‹œ');
            clearInterval(checkInterval);
            setShowInstallModal(true);
            sessionStorage.removeItem('install-mode');
          }
        }, 10); // 10msë§ˆë‹¤ ì²´í¬ (ìµœëŒ€í•œ ë¹ ë¥´ê²Œ)
        
        return () => clearInterval(checkInterval);
      }
    } else if (isInstallMode) {
      // ì¼ë°˜ install ëª¨ë“œ (ì¹´í†¡ì´ ì•„ë‹Œ ê²½ìš°)
      if (deferredPrompt) {
      console.log('[PWA] install íŒŒë¼ë¯¸í„°ì™€ deferredPrompt ëª¨ë‘ ê°ì§€, ìë™ ì„¤ì¹˜ ì‹œë„');
      setTimeout(() => {
        handleAutoInstall();
      }, 500);
      }
    } else {
      // install ëª¨ë“œê°€ ì•„ë‹ˆë©´ install-mode í”Œë˜ê·¸ ì œê±°
      sessionStorage.removeItem('install-mode');
    }
  }, [deferredPrompt, handleAutoInstall]);
  
  // ì„¤ì¹˜ ì™„ë£Œ í›„ install ëª¨ë“œ í•´ì œ
  useEffect(() => {
    if (isPWAInstalled) {
      sessionStorage.removeItem('install-mode');
    }
  }, [isPWAInstalled]);

  // URLì— install íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ (í¬ë¡¬ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²½ìš°) ìë™ ì„¤ì¹˜ ì‹œë„
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('install') === 'true') {
      console.log('[PWA] install íŒŒë¼ë¯¸í„° ê°ì§€, ì„¤ì¹˜ í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
      
      // beforeinstallprompt ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼ (ìµœëŒ€ 3ì´ˆ)
      let promptReceived = false;
      const checkPrompt = setTimeout(() => {
        if (!promptReceived) {
          console.log('[PWA] beforeinstallprompt ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ, ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´ í‘œì‹œ');
          // 3ì´ˆ í›„ì—ë„ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìœ¼ë©´ ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´
          setShowInstallModal(true);
          // URLì—ì„œ install íŒŒë¼ë¯¸í„° ì œê±°
          urlParams.delete('install');
          window.history.replaceState({}, '', window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : ''));
        }
      }, 3000);

      // deferredPromptê°€ ì„¤ì •ë˜ë©´ ìë™ìœ¼ë¡œ ì„¤ì¹˜ ì‹œë„
      if (deferredPrompt) {
        promptReceived = true;
        clearTimeout(checkPrompt);
        console.log('[PWA] deferredPrompt ë°œê²¬, ìë™ ì„¤ì¹˜ ì‹œë„');
        setTimeout(() => {
          handleAutoInstall();
        }, 500);
      } else {
        // deferredPromptë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ë¦¬ìŠ¤ë„ˆ (ë” ì ê·¹ì ìœ¼ë¡œ)
        const checkDeferredPrompt = setInterval(() => {
          if (deferredPrompt) {
            promptReceived = true;
            clearTimeout(checkPrompt);
            clearInterval(checkDeferredPrompt);
            console.log('[PWA] deferredPrompt ì„¤ì •ë¨, ìë™ ì„¤ì¹˜ ì‹œë„');
            
            // install ëª¨ë“œì¼ ë•ŒëŠ” ì¦‰ì‹œ ì„¤ì¹˜ ì‹œë„
            if (sessionStorage.getItem('install-mode')) {
              console.log('[PWA] install ëª¨ë“œì—ì„œ ì¦‰ì‹œ ì„¤ì¹˜ ì‹œë„');
              setTimeout(() => {
                handleAutoInstall();
              }, 300); // ë” ë¹ ë¥´ê²Œ ì‹¤í–‰
            } else {
            setTimeout(() => {
              handleAutoInstall();
            }, 500);
          }
          }
        }, 50); // 100ms -> 50msë¡œ ë” ë¹ ë¥´ê²Œ ì²´í¬

        // 5ì´ˆ í›„ ì²´í¬ ì¤‘ë‹¨ (3ì´ˆ -> 5ì´ˆë¡œ ì—°ì¥)
        setTimeout(() => {
          clearInterval(checkDeferredPrompt);
          if (!promptReceived) {
            console.log('[PWA] deferredPrompt íƒ€ì„ì•„ì›ƒ, ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´');
            // install ëª¨ë“œì¼ ë•ŒëŠ” ëª¨ë‹¬ í‘œì‹œ
            if (sessionStorage.getItem('install-mode')) {
              setShowInstallModal(true);
            }
          }
        }, 5000);
      }

      return () => {
        clearTimeout(checkPrompt);
      };
    }
  }, [deferredPrompt, handleInstallClick]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 via-pink-50 to-purple-50">
      {/* í”Œë¡œíŒ… í”„ë¡œëª¨ì…˜ ìœ„ì ¯ */}
      <FloatingPromoWidget landingUrl="#" />
      {/* Header */}
      <header className="border-b bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div className="container mx-auto px-3 py-2 sm:px-4 sm:py-4">
          <div className="flex items-center justify-between">
            <div 
              onClick={(e) => {
                e.preventDefault();
                if (location !== '/') {
                  setLocation('/');
                }
                // ì´ë¯¸ "/" ê²½ë¡œì— ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (í”„ë¦¬ì§• ë°©ì§€)
              }}
              className="flex items-center gap-2 cursor-pointer"
            >
                <img 
                  src="/logo-bear-nobg.png" 
                  alt="ë§ˆì´ì¿ í°" 
                  className="w-10 h-10 sm:w-12 sm:h-12 animate-wave"
                />
                <span className="text-xl sm:text-2xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent whitespace-nowrap">
                  ë§ˆì´ì¿ í°
                </span>
              </div>

          <div className="flex items-center gap-3">
            {/* install ëª¨ë“œì—ì„œëŠ” ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì¼ì‹œì ìœ¼ë¡œ ë¬´ì‹œ (ì„¤ì¹˜ì— ì§‘ì¤‘) */}
            {/* ë¡œê·¸ì¸ í›„ ì¦‰ì‹œ í‘œì‹œ: loadingì´ falseì´ê±°ë‚˜ userê°€ ìˆìœ¼ë©´ í‘œì‹œ */}
            {user && !sessionStorage.getItem('install-mode') ? (
              <>
                {/* ì¼ë°˜ ìœ ì €ì—ê²Œë§Œ ë©”ë‰´ 3ê°œ í‘œì‹œ */}
                {user.role === 'user' && !loading && (
                  <div className="hidden sm:flex items-center gap-4 text-sm">
                    <Link href="/map">
                      <span className="cursor-pointer hover:text-primary transition-colors">ë‚´ ì¿ í° ì°¾ê¸°</span>
                    </Link>
                    <span className="text-gray-300">|</span>
                    <Link href="/my-coupons">
                      <span className="cursor-pointer hover:text-primary transition-colors">ë‚´ ì¿ í°ë¶</span>
                    </Link>
                    <span className="text-gray-300">|</span>
                    <Link href="/gamification">
                      <span className="cursor-pointer hover:text-primary transition-colors">ë§ˆì´ì¿ í° í™œë™</span>
                    </Link>
                  </div>
                )}
                
                {/* ì¼ë°˜ ìœ ì €ì—ê²Œë§Œ ì•Œë¦¼ ë°°ì§€ í‘œì‹œ */}
                {user.role === 'user' && <NotificationBadge />}
                
                {/* ê´€ë¦¬ì/ì‚¬ì¥ë‹˜ì—ê²ŒëŠ” ê´€ë¦¬ì ë²„íŠ¼ë§Œ */}
                {(user.role === 'admin' || user.role === 'merchant') && (
                  <Link href="/admin">
                    <Button variant="outline" className="rounded-xl">
                      ê´€ë¦¬ì
                    </Button>
                  </Link>
                )}
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="sm" className="rounded-full p-0 h-auto">
                      <div className="w-10 h-10 bg-gradient-to-br from-pink-400 to-purple-400 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer hover:opacity-80 transition-opacity">
                        {user.name?.[0] || 'U'}
                      </div>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end" className="w-48">
                    <div className="px-2 py-1.5 text-sm font-medium">{user.name}</div>
                    <div className="px-2 py-1 text-xs text-muted-foreground">{user.email}</div>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem onClick={() => setLocation('/my-coupons')}>
                      <Gift className="w-4 h-4 mr-2" />
                      ë‚´ ì¿ í°ë¶
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setLocation('/gamification')}>
                      <User className="w-4 h-4 mr-2" />
                      ë§ˆì´ì¿ í° í™œë™
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => setLocation('/notification-settings')}>
                      <Bell className="w-4 h-4 mr-2" />
                      ì•Œë¦¼ ì„¤ì •
                    </DropdownMenuItem>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem 
                      onClick={() => logoutMutation.mutate()}
                      className="text-red-600"
                    >
                      <LogOut className="w-4 h-4 mr-2" />
                      ë¡œê·¸ì•„ì›ƒ
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </>
            ) : (
              <>
                {/* CRITICAL: PWA ì¬ì„¤ì¹˜ ì™„ë²½ ë³µêµ¬ - standalone ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜ beforeinstallprompt ë°œìƒ ì‹œ ë²„íŠ¼ í‘œì‹œ */}
                {/* ë¸Œë¼ìš°ì € ëª¨ë“œ(!isStandalone) ë˜ëŠ” deferredPromptê°€ ìˆìœ¼ë©´ ì„¤ì¹˜ ê°€ëŠ¥ */}
                {(!isStandalone || deferredPrompt) && (
                  <Button 
                    variant="outline" 
                    className="rounded-xl bg-gradient-to-r from-orange-400 via-pink-400 to-pink-500 text-white border-0 shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      
                      // ì¦‰ì‹œ í™ˆ í™”ë©´ ì¶”ê°€ ê°€ì´ë“œ ëª¨ë‹¬ í‘œì‹œ (deferredPrompt ëŒ€ê¸° ì—†ì´, ìµœëŒ€ ì†ë„)
                      console.log('[Home] ì•± ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­, ì¦‰ì‹œ í™ˆ í™”ë©´ ì¶”ê°€ ê°€ì´ë“œ ëª¨ë‹¬ í‘œì‹œ');
                      setShowInstallModal(true);
                      
                      // Androidì—ì„œ deferredPromptê°€ ìˆìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ë„ ì‹œë„
                      const isAndroidDevice = /Android/.test(navigator.userAgent);
                      if (isAndroidDevice && deferredPrompt) {
                        console.log('[Home] Android deferredPrompt ë°œê²¬, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì‹œë„');
                        // ëª¨ë‹¬ì€ ì´ë¯¸ í‘œì‹œí–ˆìœ¼ë¯€ë¡œ, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ë„ ì‹œë„
                        handleInstallClick().catch(() => {
                          // ì‹¤íŒ¨í•´ë„ ëª¨ë‹¬ì€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìŒ
                        });
                      }
                    }}
                    disabled={false}
                    style={{ 
                      pointerEvents: 'auto', 
                      zIndex: 1000,
                      cursor: 'pointer',
                      position: 'relative'
                    }}
                  >
                    {isInstalling ? (
                      <>
                        <div className="w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        ì„¤ì¹˜ ì¤‘...
                      </>
                    ) : (
                      <>
                        <Download className="w-4 h-4 mr-2" />
                        ì•± ë‹¤ìš´ë¡œë“œ
                      </>
                    )}
                  </Button>
                )}
                <Button
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ì¦‰ì‹œ ì²´í¬)
                    if (loginClickRef.current || isLoginLoading) {
                      return;
                    }
                    loginClickRef.current = true;
                    
                    // ë‚™ê´€ì  UI ë°˜ì˜: ë²„íŠ¼ í´ë¦­ ì¦‰ì‹œ ë¡œë”© ìƒíƒœ í‘œì‹œ
                    setIsLoginLoading(true);
                    
                    // ì¦‰ì‹œ í”¼ë“œë°±: ë²„íŠ¼ ëˆŒë¦¼ íš¨ê³¼
                    const button = e.currentTarget;
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                      button.style.transform = '';
                    }, 150);
                    
                    console.log('[Home] ğŸš€ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ - ì¦‰ì‹œ OAuth í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    
                    // ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ëª¨ë“  ì²´í¬ ì œê±°, ì„±ëŠ¥ ìµœì í™”)
                    const loginUrl = getLoginUrl();
                    
                    // requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‹¤í–‰ (ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ê³¼ ë™ê¸°í™”)
                    requestAnimationFrame(() => {
                      window.location.href = loginUrl;
                    });
                    
                    // 3ì´ˆ í›„ í”Œë˜ê·¸ ë¦¬ì…‹ (ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨ ëŒ€ë¹„)
                    setTimeout(() => {
                      loginClickRef.current = false;
                      setIsLoginLoading(false);
                    }, 3000);
                  }}
                  className="rounded-xl bg-gradient-to-r from-primary to-accent shadow-lg hover:shadow-xl transition-all active:scale-95"
                  disabled={isLoginLoading}
                  style={{ 
                    cursor: isLoginLoading ? 'wait' : 'pointer', 
                    pointerEvents: 'auto',
                    zIndex: 1000,
                    position: 'relative'
                  }}
                >
                  {isLoginLoading ? (
                    <>
                      <Spinner className="w-4 h-4 animate-spin" />
                      ë¡œê·¸ì¸ ì‹œë„ ì¤‘...
                    </>
                  ) : (
                    'ë¡œê·¸ì¸'
                  )}
                </Button>
              </>
            )}
          </div>
        </div>
        </div>
      </header>



      {/* Hero Section */}
      <section className="relative w-full px-4 py-12 sm:py-20 text-center overflow-hidden">
        {/* Background Image */}
        <div className="absolute inset-0 z-0">
          <img
            src="/hero-background.png"
            alt="Hero Background"
            loading="lazy"
            className="w-full h-full object-cover opacity-30"
          />
        </div>
        <div className="max-w-4xl mx-auto space-y-8 relative z-10">
          <div className="inline-flex items-center gap-2 px-4 py-2 bg-white/80 rounded-full shadow-md backdrop-blur-sm">
            <Sparkles className="w-4 h-4 text-primary" />
            <span className="text-sm font-medium text-primary">20-40ëŒ€ê°€ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ì¿ í° ì•±</span>
          </div>

          <h1 className="text-5xl sm:text-6xl font-bold leading-tight">
            <span className="bg-gradient-to-r from-primary via-accent to-pink-500 bg-clip-text text-transparent">
              ìš°ì—°íˆ ë§Œë‚˜ëŠ”
            </span>
            <br />
            <span className="text-foreground">í• ì¸ì˜ ì¦ê±°ì›€</span>
          </h1>

          <p className="text-xl text-muted-foreground max-w-2xl mx-auto">
            ë‚´ ì£¼ë³€ 50më¶€í„° ì‹œì‘ë˜ëŠ” íŠ¹ë³„í•œ í• ì¸!
            <br />
            GPS ê¸°ë°˜ìœ¼ë¡œ ê°€ê¹Œìš´ ì¿ í°ì„ ìë™ìœ¼ë¡œ ì°¾ì•„ë“œë ¤ìš”.
          </p>

          <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
              <Button
                size="lg"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // ì¤‘ë³µ í´ë¦­ ë°©ì§€
                if (searchClickRef.current || isSearchLoading) {
                  console.log('[Home] ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸° ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€');
                  return;
                }
                searchClickRef.current = true;
                setIsSearchLoading(true);
                
                console.log('[Home] ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸° ë²„íŠ¼ í´ë¦­');
                
                // ì¦‰ì‹œ í”¼ë“œë°±: ë²„íŠ¼ ëˆŒë¦¼ íš¨ê³¼
                const button = e.currentTarget;
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                  button.style.transform = '';
                }, 150);
                
                // ì¦‰ì‹œ ì´ë™ ì‹œë„ (ë¡œê·¸ì¸ ì¤‘ì´ì–´ë„ ì´ë™ ê°€ëŠ¥)
                try {
                  // requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‹¤í–‰
                  requestAnimationFrame(() => {
                    setLocation('/map');
                  });
                } catch (error) {
                  console.error('[Home] ê²½ë¡œ ì´ë™ ì‹¤íŒ¨:', error);
                  searchClickRef.current = false;
                  setIsSearchLoading(false);
                  toast.error('í˜ì´ì§€ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                  return;
                }
                
                // 1ì´ˆ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
                setTimeout(() => {
                  searchClickRef.current = false;
                  setIsSearchLoading(false);
                }, 1000);
              }}
                className="rounded-2xl bg-gradient-to-r from-primary to-accent text-white px-8 py-6 text-lg font-bold shadow-2xl hover:shadow-3xl hover:scale-105 transition-all active:scale-95"
              disabled={isSearchLoading}
              style={{ 
                cursor: isSearchLoading ? 'wait' : 'pointer', 
                pointerEvents: 'auto',
                zIndex: 1000,
                position: 'relative'
              }}
              >
                {isSearchLoading ? (
                  <>
                    <Spinner className="w-6 h-6 mr-2 text-white" />
                    ì°¾ëŠ” ì¤‘...
                  </>
                ) : (
                  <>
                    <MapPin className="w-6 h-6 mr-2" />
                    ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸°
                  </>
                )}
              </Button>
          </div>

          {/* Stats - ë„¤ëª¨ ë°•ìŠ¤ë¡œ ê°•ì¡° */}
          <div className="grid grid-cols-3 gap-4 max-w-3xl mx-auto pt-12">
            <Card className="bg-white/90 backdrop-blur-sm border-2 border-primary/20 shadow-lg">
              <CardContent className="p-6 text-center space-y-2">
                <Store className="w-8 h-8 text-primary mx-auto" />
                <div className="text-3xl font-bold text-primary">8+</div>
                <div className="text-sm text-muted-foreground font-medium">ì œíœ´ ë§¤ì¥</div>
              </CardContent>
            </Card>
            <Card className="bg-white/90 backdrop-blur-sm border-2 border-accent/20 shadow-lg">
              <CardContent className="p-6 text-center space-y-2">
                <Ticket className="w-8 h-8 text-accent mx-auto" />
                <div className="text-3xl font-bold text-accent">100+</div>
                <div className="text-sm text-muted-foreground font-medium">ë°œí–‰ ì¿ í°</div>
              </CardContent>
            </Card>
            <Card className="bg-white/90 backdrop-blur-sm border-2 border-pink-500/20 shadow-lg">
              <CardContent className="p-6 text-center space-y-2">
                <Percent className="w-8 h-8 text-pink-500 mx-auto" />
                <div className="text-3xl font-bold text-pink-500">50%</div>
                <div className="text-sm text-muted-foreground font-medium">í‰ê·  í• ì¸ìœ¨</div>
              </CardContent>
            </Card>
          </div>
        </div>
      </section>

      {/* Features Section - ê°„ì†Œí™” */}
      <section className="w-full px-4 py-20">
        <div className="text-center mb-16">
          <h2 className="text-4xl font-bold mb-4">
            <span className="bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
              ì™œ ë§ˆì´ì¿ í°ì¼ê¹Œìš”?
            </span>
          </h2>
          <p className="text-lg text-muted-foreground">
            GPS ê¸°ë°˜ ì‹¤ì‹œê°„ ê±°ë¦¬ í‘œì‹œë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì¿ í°ì„ ì°¾ì•„ë“œë ¤ìš”
          </p>
        </div>

        <div className="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
          <Card className="border-2 border-primary/20 hover:border-primary/40 transition-all hover:shadow-xl rounded-3xl overflow-hidden group relative">
            <CardContent className="p-8 space-y-4">
              {/* Card Background Image */}
              <div className="absolute inset-0 z-0 opacity-10">
                <img src="/gps-card.png" alt="GPS" className="w-full h-full object-contain" loading="lazy" />
              </div>
              <div className="relative z-10 w-16 h-16 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                <MapPin className="w-8 h-8 text-white" />
              </div>
              <h3 className="text-2xl font-bold relative z-10">GPS ê±°ë¦¬ ì •ë³´</h3>
              <p className="text-muted-foreground relative z-10">
                "50m ì•", "200m ì•" ì‹¤ì‹œê°„ ê±°ë¦¬ í‘œì‹œë¡œ ê°€ê¹Œìš´ ì¿ í°ì„ ë°”ë¡œ ì°¾ì•„ìš”
              </p>
            </CardContent>
          </Card>

          <Card className="border-2 border-accent/20 hover:border-accent/40 transition-all hover:shadow-xl rounded-3xl overflow-hidden group relative">
            <CardContent className="p-8 space-y-4">
              {/* Card Background Image */}
              <div className="absolute inset-0 z-0 opacity-10">
                <img src="/ai-card.png" alt="AI" className="w-full h-full object-contain" loading="lazy" />
              </div>
              <div className="relative z-10 w-16 h-16 bg-gradient-to-br from-accent to-pink-500 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                <Sparkles className="w-8 h-8 text-white" />
              </div>
              <h3 className="text-2xl font-bold relative z-10">AI ê°œì¸í™” ì¶”ì²œ</h3>
              <p className="text-muted-foreground relative z-10">
                ë‚´ê°€ ìì£¼ ê°€ëŠ” ì¹´í˜, ì¢‹ì•„í•˜ëŠ” ìŒì‹ì  ì¿ í°ì„ ìš°ì„  ì¶”ì²œí•´ë“œë ¤ìš”
              </p>
            </CardContent>
          </Card>

          <Card className="border-2 border-pink-500/20 hover:border-pink-500/40 transition-all hover:shadow-xl rounded-3xl overflow-hidden group relative">
            <CardContent className="p-8 space-y-4">
              {/* Card Background Image */}
              <div className="absolute inset-0 z-0 opacity-10">
                <img src="/notification-card.png" alt="Notification" className="w-full h-full object-contain" loading="lazy" />
              </div>
              <div className="relative z-10 w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-500 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                <Zap className="w-8 h-8 text-white" />
              </div>
              <h3 className="text-2xl font-bold relative z-10">ì‹¤ì‹œê°„ ì•Œë¦¼</h3>
              <p className="text-muted-foreground relative z-10">
                ì§€ê¸ˆ ê·¼ì²˜ì— ìˆëŠ” ì¿ í°ì„ í‘¸ì‹œ ì•Œë¦¼ìœ¼ë¡œ ë°”ë¡œ ì•Œë ¤ë“œë ¤ìš”
              </p>
            </CardContent>
          </Card>
        </div>
      </section>

      {/* For Merchants Section - ê°œì„ ëœ ë ˆì´ì•„ì›ƒ */}
      <section className="w-full px-4 py-20">
        <div className="max-w-5xl mx-auto">
          <div className="bg-gradient-to-br from-orange-100 to-pink-100 rounded-3xl p-12 space-y-8 relative overflow-hidden">
            {/* Background Image */}
            <div className="absolute inset-0 z-0">
              <img src="/merchant-section-bg.png" alt="Merchant" className="w-full h-full object-cover opacity-30" loading="lazy" />
            </div>
            
            <div className="text-center space-y-4 relative z-10">
              <h2 className="text-4xl font-bold">ì‚¬ì¥ë‹˜ì„ ìœ„í•œ íŠ¹ë³„í•œ í˜œíƒ</h2>
              <p className="text-xl text-muted-foreground">
                ì €í¬ëŠ” <span className="font-bold text-primary">ì†ë‹˜ì„ ë¨¼ì € ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</span>
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 relative z-10">
              <Card className="bg-white/90 backdrop-blur-sm border-2 rounded-2xl hover:shadow-lg transition-shadow">
                <CardContent className="p-6 md:p-8 space-y-3 md:space-y-4">
                  <div className="flex items-center gap-3">
                    <img src="/icon-performance-pay-nobg.png" alt="ì„±ê³¼í˜• ê³¼ê¸ˆ" className="w-12 h-12 md:w-14 md:h-14" loading="lazy" />
                    <h3 className="text-lg md:text-xl font-bold">ì„±ê³¼í˜• ê³¼ê¸ˆ</h3>
                  </div>
                  <p className="text-muted-foreground text-sm md:text-base">
                    ì¿ í° ì‚¬ìš© 1ê±´ë‹¹ 1,000ì›
                    <br />
                    <span className="font-bold text-primary">ë°©ë¬¸ ì—†ìœ¼ë©´ 0ì›!</span>
                  </p>
                </CardContent>
              </Card>

              <Card className="bg-white/90 backdrop-blur-sm border-2 rounded-2xl hover:shadow-lg transition-shadow">
                <CardContent className="p-6 md:p-8 space-y-3 md:space-y-4">
                  <div className="flex items-center gap-3">
                    <img src="/icon-free-start-nobg.png" alt="ì´ˆê¸° ë¹„ìš© ë¬´ë£Œ" className="w-12 h-12 md:w-14 md:h-14" loading="lazy" />
                    <h3 className="text-lg md:text-xl font-bold">ì´ˆê¸° ë¹„ìš© ë¬´ë£Œ</h3>
                  </div>
                  <p className="text-muted-foreground text-sm md:text-base">
                    ê°€ì…ë¹„ 0ì›
                    <br />
                    <span className="font-bold text-green-600">ì›” ê´€ë¦¬ë¹„ë„ 0ì›!</span>
                  </p>
                </CardContent>
              </Card>

              <Card className="bg-white/90 backdrop-blur-sm border-2 rounded-2xl hover:shadow-lg transition-shadow">
                <CardContent className="p-6 md:p-8 space-y-3 md:space-y-4">
                  <div className="flex items-center gap-3">
                    <img src="/icon-analytics-nobg.png" alt="ì‹¤ì‹œê°„ ë¶„ì„" className="w-12 h-12 md:w-14 md:h-14" loading="lazy" />
                    <h3 className="text-lg md:text-xl font-bold">ì‹¤ì‹œê°„ ë¶„ì„</h3>
                  </div>
                  <p className="text-muted-foreground text-sm md:text-base">
                    ì¿ í° ë°œí–‰/ì‚¬ìš© í˜„í™©
                    <br />
                    <span className="font-bold text-pink-600">ROI í•œëˆˆì— í™•ì¸!</span>
                  </p>
                </CardContent>
              </Card>

              <Card className="bg-white/90 backdrop-blur-sm border-2 rounded-2xl hover:shadow-lg transition-shadow">
                <CardContent className="p-6 md:p-8 space-y-3 md:space-y-4">
                  <div className="flex items-center gap-3">
                    <img src="/icon-gps-targeting-nobg.png" alt="GPS íƒ€ê²ŸíŒ…" className="w-12 h-12 md:w-14 md:h-14" loading="lazy" />
                    <h3 className="text-lg md:text-xl font-bold">GPS íƒ€ê²ŸíŒ…</h3>
                  </div>
                  <p className="text-muted-foreground text-sm md:text-base">
                    ê·¼ì²˜ ê³ ê°ì—ê²Œ
                    <br />
                    <span className="font-bold text-purple-600">ìë™ ì¿ í° ë…¸ì¶œ!</span>
                  </p>
                </CardContent>
              </Card>
            </div>

            <div className="text-center relative z-10">
              <Link href="/merchant/dashboard">
                <Button
                  size="lg"
                  className="rounded-2xl bg-gradient-to-r from-primary to-accent text-white px-10 py-7 text-xl font-bold shadow-xl hover:shadow-2xl hover:scale-105 transition-all"
                >
                  ì‚¬ì¥ë‹˜ ì‹œì‘í•˜ê¸°
                </Button>
              </Link>
            </div>
          </div>
        </div>
      </section>

      {/* CTA Section - ê°œì„ ëœ ë ˆì´ì•„ì›ƒ */}
      <section className="w-full px-4 py-20 relative overflow-hidden">
        {/* Background Image */}
        <div className="absolute inset-0 z-0">
          <img src="/cta-section-bg.png" alt="CTA" className="w-full h-full object-cover opacity-40" loading="lazy" />
        </div>
        <div className="max-w-4xl mx-auto relative z-10">
          <Card className="bg-white/90 backdrop-blur-sm border-2 border-primary/20 shadow-2xl" style={{borderRadius: '1.5rem'}}>
            <CardContent className="p-8 md:p-12 text-center space-y-6 md:space-y-8">
              <h2 className="text-3xl md:text-5xl font-bold leading-tight">
                ì§€ê¸ˆ ìš°ë¦¬ë™ë„¤ ì¿ í°ì„
                <br />
                ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
              </h2>
              <div className="space-y-3">
                <p className="text-xl md:text-2xl font-bold text-primary">
                  ê°€ì… ë¬´ë£Œ Â· ì•± ë‹¤ìš´ë¡œë“œ í•„ìš” ì—†ìŒ
                </p>
                <p className="text-lg md:text-xl text-muted-foreground">
                  ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ì§€ê¸ˆ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•´ìš”
                </p>
              </div>
                <Button
                  size="lg"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  
                  // ì¤‘ë³µ í´ë¦­ ë°©ì§€
                  if (searchClickRef.current || isSearchLoading) {
                    console.log('[Home] ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸° ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€ (CTA)');
                    return;
                  }
                  searchClickRef.current = true;
                  setIsSearchLoading(true);
                  
                  console.log('[Home] ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸° ë²„íŠ¼ í´ë¦­ (CTA ì„¹ì…˜)');
                  
                  // ì¦‰ì‹œ í”¼ë“œë°±: ë²„íŠ¼ ëˆŒë¦¼ íš¨ê³¼
                  const button = e.currentTarget;
                  button.style.transform = 'scale(0.95)';
                  setTimeout(() => {
                    button.style.transform = '';
                  }, 150);
                  
                  // ì¦‰ì‹œ ì´ë™ ì‹œë„ (ë¡œê·¸ì¸ ì¤‘ì´ì–´ë„ ì´ë™ ê°€ëŠ¥)
                  try {
                    // requestAnimationFrameìœ¼ë¡œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‹¤í–‰
                    requestAnimationFrame(() => {
                      setLocation('/map');
                    });
                  } catch (error) {
                    console.error('[Home] ê²½ë¡œ ì´ë™ ì‹¤íŒ¨:', error);
                    searchClickRef.current = false;
                    setIsSearchLoading(false);
                    toast.error('í˜ì´ì§€ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                  }
                  
                  // 1ì´ˆ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
                  setTimeout(() => {
                    searchClickRef.current = false;
                    setIsSearchLoading(false);
                  }, 1000);
                }}
                  className="rounded-2xl bg-gradient-to-r from-primary to-accent text-white px-10 md:px-14 py-6 md:py-8 text-lg md:text-2xl font-bold shadow-2xl hover:shadow-3xl hover:scale-105 transition-all active:scale-95 w-full md:w-auto"
                disabled={isSearchLoading}
                style={{ 
                  cursor: isSearchLoading ? 'wait' : 'pointer', 
                  pointerEvents: 'auto',
                  zIndex: 1000,
                  position: 'relative'
                }}
                >
                  {isSearchLoading ? (
                    <>
                      <Spinner className="w-6 h-6 md:w-7 md:h-7 mr-2 md:mr-3 text-white" />
                      ì°¾ëŠ” ì¤‘...
                    </>
                  ) : (
                    <>
                      <Heart className="w-6 h-6 md:w-7 md:h-7 mr-2 md:mr-3 fill-white" />
                      ë‚´ ì£¼ë³€ ì¿ í° ì°¾ê¸°
                    </>
                  )}
                </Button>
            </CardContent>
          </Card>
        </div>
      </section>

      {/* Footer */}
      <footer className="border-t bg-white/80 backdrop-blur-md mt-20">
        <div className="container mx-auto px-4 py-8 text-center text-sm text-muted-foreground">
          <p>Â© 2024 ë§ˆì´ì¿ í°. All rights reserved.</p>
          <p className="mt-2">ê±·ë‹¤ê°€ ë§Œë‚˜ëŠ” í• ì¸ì˜ ì¦ê±°ì›€</p>
        </div>
      </footer>

      {/* ì„¤ì¹˜ ì•ˆë‚´ ëª¨ë‹¬ (iOS Safari ì „ìš©) */}
      <InstallModal 
        open={showInstallModal} 
        onOpenChange={setShowInstallModal}
        landingUrl={window.location.origin}
      />
      
      {/* Install ëª¨ë“œ ì¬ì‹œì‘ ì•ˆë‚´ ëª¨ë‹¬ */}
      <InstallModeRestartModal
        open={showInstallModeRestartModal}
        onOpenChange={setShowInstallModeRestartModal}
      />
    </div>
  );
}
